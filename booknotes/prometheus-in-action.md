# 《Prometheus 监控实战》笔记

## 第一章

与安全性一样，监控也应该是应用程序的核心功能。

如果应用程序在你没有注意到的情况下发生了故障，那么及时进行了监控，你也需要考虑下正在监控的内容是否合
理。

应该监控业务事务的内容或速率，而不是监控它运行的 Web 服务器的运行时间。

静态阈值几乎总是错误的，比如说只监控 CPU 超过 80% 的情况

监控的两种机制：

- 探针，当我们对要监控的资源没有控制权的时候
- 内省

显然，应该优先采用内省来监控。但是如果应用程序由第三方提供，并且你没有深入了解其内部操作的时候。从外
部查看应用程序以了解某些网络、安全性或可用性问题通常也很有帮助。

指标是一个组件属性的度量，对这个指标持续跟踪，观察的集合称为时间序列。

单一指标和聚合指标的组合可以提供最佳的健康视图：前者可深入到某个特定问题，而后者可以查看更高阶的状态。

使用平均值描述事件序列是非常危险的。有个笑话是：一位统计学家跳进平均深度只有 25 厘米的湖中，然后差点被
淹死，因为湖中有深达十米的大洞，虽然大部分水面深度只有 10cm

平局值的坏处就在于高峰和低谷可能被平均值所掩盖。百分位数才是识别异常值的理想选择。

### 监控方法论

Gregg 的 USE 指标：

- Utilization（使用率）. 资源忙于工作的平均时间，通常用随时间变化的百分比表示。
- Saturatioin（饱和度）. 资源排队工作的指标，无法处理额外的工作。通常用队列长度表示。
- Error（错误）. 错误事件的计数

Google 的四个黄金指标

- 延迟：服务请求所花费的时间，需要区分成功和失败请求。因为失败请求可能延迟非常低，但是结果是错的
- 流量：QPS 或者 TPS
- 错误：错误的速率。包括空响应和超时等隐式错误
- 饱和度：受限的资源，和上面类似

Weaveworks 的 RED 指标

- Rate（流量）
- Error（错误率）
- Duration（延迟）

实际上已经被包含在 Google 的四个指标中了

### 警报和通知

- 哪些问题需要通知
- 谁需要被告知
- 如何告知他们
- 多久告知他们一次
- 何时停止通知或升级到其他人

通知的信息应该包含以下几方面：

- 清晰准确，可操作。应该让人能够看懂并知道如何操作
- 为通知添加上下文，应该包含其他组件的相关信息
- 只发送有意义的通知，不要因为有了通知系统就一定要使用

### 可视化

可视化系统最终要的在于：突出重点而不仅是提升视觉效果。


## 第二章

大多数监控查询和警报都是从最近（通常是一天内）的数据产生的。

Prometheus 的高可用架构建议：

- 使用两个或多个相同配置的 Prometheus 服务器收集指标
- 所有生成的警报发送到一个 Alertmanger 的集群，由 altermanager 进行消重

## 第三章

强烈建议不要单独配置每个服务的指标抓取间隔，这样能够确保你的所有时间序列具有相同的粒度。

即使向量 (Instant Vector): 一组包含每个时间序列的单个样本的时间序列集合

## 第四章

cAdvisor 作为容器运行，可以用来监控 Docker
