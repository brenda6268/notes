# 一些新的协议（QUIC)

<!--
ID: 43d9f88e-c58a-453c-9033-15f29acabf97
Status: draft
Date: 2018-04-19T01:12:00
Modified: 2020-05-16T11:36:24
wp_id: 418
-->

## QUIC

http2 的问题

1. 只使用一个 TCP 链接，导致线头阻塞，如果丢包的话，会导致所有的连接都被阻塞住。http1 则是建立多个连接。
2. 所有的防火墙都只认 TCP 或者 UDP，所以没有办法使用新的协议。
3. TCP 协议僵化，互联网中间的好多设备都比较老了，协议的新选项他们都不认，直接就把包丢了。比如说 fast open

- QUIC 使用 TLS 1.3
- QUIC 协议基于 UDP 但实现了 TCP 的一些拥塞控制等功能，也是可靠连接
- QUIC 有多个逻辑数据流
- QUIC 可以 0RTT 或者 1RTT 建立连接
- QUIC 可以实现连接漫游，利用 Connection ID
- QUIC 通过旋转比特位实现观察。在每一次往返时，连接双方都翻转这一比特的值
- QUIC 目前在 userspace 实现，协议的演进更为容易

可以通过 `Alt-Svc: h3=":50781"` 协商升级到 QUIC 协议。

https 和 http2 这些协议都依赖与 TLS，而使用了 TLS 之后建立一个会话要三次握手，也就是 3 RTT，比较耗时。

TCP 协议这么多年改进不大，而且由于一些路由器还有 winxp 这些老旧系统的存在，比如好多防火墙只允许 80 和 443 端口等，一些改进也难以直接产生影响。

QUIC 相对于 http2 + tcp + tls 的改进有：

1. 减少握手时间。3rtt -> 0rtt
2. 拥塞控制由应用层来做，而不是 tcp 本身。在系统层面也不需要内核参与，也就是说可插拔的，随意替换控制算法。
3. 避免队头阻塞

使用了前向加密，不需要 tls 握手。

QUIC 也是一个可靠的协议，使用了 packet number 代替 seq number，但是 packet number 严格递增，重传也会使用新的更大的 packet number。

链接迁移

tcp 使用四元组来确定一条链接，在 4G 环境下，改变 IP 是很常见的行为，这时候只能重新建立一条 TCP 链接。而 QUIC 不再使用四元组作为链接的标识，而是使用一个 64bit 的随机数作为连接标识，由客户端随机产生。